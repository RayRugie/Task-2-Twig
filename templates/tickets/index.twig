{% extends "base.twig" %}

{% block title %}Tickets - Ticketa{% endblock %}

{% block stylesheets %}
<link href="/css/tickets.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="tickets-page">
    <a href="/dashboard" class="back-button">
        ← Back
    </a>

    <div class="tickets-container">
        <h1>🎫 Ticket Management</h1>
        <p>Manage your tickets — create, edit, and resolve issues easily.</p>



        <form class="ticket-form-container" method="POST" action="/tickets" id="ticketForm">
            <input type="hidden" name="{{ csrf_token_name }}" value="{{ csrf_token }}">
            <h3>{{ selected_ticket ? 'Edit Ticket' : 'Create New Ticket' }}</h3>
            
            <label>
                Title
                <input type="text" name="title" value="{{ selected_ticket.title|default('') }}" required>
            </label>

            <label>
                Description
                <textarea name="description" required>{{ selected_ticket.description|default('') }}</textarea>
            </label>

            <label>
                Status
                <select name="status" required>
                    <option value="open" {{ selected_ticket and selected_ticket.status == 'open' ? 'selected' : '' }}>Open</option>
                    <option value="in_progress" {{ selected_ticket and selected_ticket.status == 'in_progress' ? 'selected' : '' }}>In Progress</option>
                    <option value="closed" {{ selected_ticket and selected_ticket.status == 'closed' ? 'selected' : '' }}>Closed</option>
                </select>
            </label>

            <div class="form-actions">
                <button type="submit" class="submit-btn">{{ selected_ticket ? 'Update Ticket' : 'Create Ticket' }}</button>
                {% if selected_ticket %}
                <a href="/tickets" class="cancel-btn">Cancel</a>
                {% endif %}
            </div>
        </form>

        <div class="tickets-list">
            {% if tickets %}
                {% for ticket in tickets %}
                <div class="ticket-card">
                    <h4>{{ ticket.title }}</h4>
                    <p>{{ ticket.description }}</p>
                    
                    <div class="ticket-meta">
                        <span>{{ ticket.created_at|date('M j, Y') }}</span>
                        <span class="status {{ ticket.status }}">{{ ticket.status }}</span>
                    </div>

                    <div class="actions">
                        <a href="/tickets/{{ ticket.id }}/edit" class="edit-btn">✏️ Edit</a>
                        <form method="POST" action="/tickets/{{ ticket.id }}/delete" style="display:inline;" onsubmit="return confirm('Are you sure?')">
                            <input type="hidden" name="{{ csrf_token_name }}" value="{{ csrf_token }}">
                            <button type="submit" class="delete-btn">🗑️ Delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
                {% if pagination and (pagination.has_prev or pagination.has_next) %}
                <nav class="pagination" style="margin-top:16px; display:flex; gap:12px; align-items:center;">
                    {% set base_qs = filter_status ? 'status=' ~ filter_status ~ '&' : '' %}
                    {% if pagination.has_prev %}
                        <a class="btn" href="/tickets?{{ base_qs }}page={{ pagination.page - 1 }}&per_page={{ pagination.per_page }}">Prev</a>
                    {% endif %}
                    <span>Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
                    {% if pagination.has_next %}
                        <a class="btn" href="/tickets?{{ base_qs }}page={{ pagination.page + 1 }}&per_page={{ pagination.per_page }}">Next</a>
                    {% endif %}
                </nav>
                {% endif %}
            {% else %}
                <p class="no-tickets">No tickets found. Create one above!</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
